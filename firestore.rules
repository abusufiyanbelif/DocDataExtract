rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isOwnerOfUserKey(userKey) {
        let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        return userData.userKey == userKey;
    }

    // Get the requesting user's profile data from the 'users' collection
    function getUserData() {
      // Important: Use the request's auth uid, not a wildcard from the path
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return isSignedIn() && getUserData().role == 'Admin';
    }

    // Check for a specific permission in the user's profile
    function hasPermission(pathSegments, permission) {
      // A user must be signed in to have any permissions.
      if (!isSignedIn()) {
        return false;
      }
      // Admins have all permissions implicitly
      if (isAdmin()) {
        return true;
      }
      
      let perms = getUserData().permissions;
      // Traverse the permission path
      for (let i = 0; i < pathSegments.length; i = i + 1) {
        if (pathSegments[i] in perms) {
          perms = perms[pathSegments[i]];
        } else {
          return false; // Path doesn't exist
        }
      }
      // Check the final permission
      return (permission in perms) && perms[permission] == true;
    }
    
    function canReadCampaign() {
      return hasPermission(['campaigns'], 'read') || 
             hasPermission(['campaigns', 'summary'], 'read') ||
             hasPermission(['campaigns', 'ration'], 'read') ||
             hasPermission(['campaigns', 'beneficiaries'], 'read') ||
             hasPermission(['campaigns', 'donations'], 'read');
    }

    function campaignSummaryKeys() { 
      return ['name', 'category', 'description', 'targetAmount', 'startDate', 'endDate', 'status']; 
    }
    function campaignRationKeys() { 
      return ['priceDate', 'shopName', 'shopContact', 'shopAddress', 'rationLists']; 
    }
    
    function canReadLead() {
      return hasPermission(['leads'], 'read') || 
             hasPermission(['leads', 'summary'], 'read') ||
             hasPermission(['leads', 'ration'], 'read') ||
             hasPermission(['leads', 'beneficiaries'], 'read') ||
             hasPermission(['leads', 'donations'], 'read');
    }

    // --- Collection Rules ---

    match /user_lookups/{lookupId} {
      allow read: if true;
      
      // Allow write if user is admin OR if user is creating/updating their own lookup OR for seeding the first admin.
      allow create, update: if (hasPermission(['users'], 'create') || hasPermission(['users'], 'update')) ||
                              (isSignedIn() && isOwnerOfUserKey(request.resource.data.userKey)) ||
                              (lookupId == 'admin' || lookupId == '9270946423');
                              
      // Allow delete if user is admin OR if user is deleting their own lookup.
      allow delete: if (hasPermission(['users'], 'delete')) ||
                      (isSignedIn() && isOwnerOfUserKey(resource.data.userKey));
    }

    match /users/{userId} {
      allow get: if hasPermission(['users'], 'read') || isOwner(userId);
      allow list: if hasPermission(['users'], 'read');
      
      // Allow creating a user if they have permission OR it's the initial admin seed.
      allow create: if hasPermission(['users'], 'create') || (request.resource.data.userKey == 'admin' && request.resource.data.role == 'Admin');

      // Admins can update any field.
      // A user can only update their own name and phone number.
      allow update: if hasPermission(['users'], 'update') || 
                      (isOwner(userId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'phone']));
                      
      allow delete: if hasPermission(['users'], 'delete');
    }

    match /campaigns/{campaignId} {
      // Allow public read for summary page, but restrict write access
      allow get, list: if true;
      
      // Creating a campaign
      allow create: if hasPermission(['campaigns'], 'create');
      
      // Updating a campaign document itself requires specific permissions
      allow update: if 
        hasPermission(['campaigns'], 'update') ||
        isAdmin() ||
        (
          hasPermission(['campaigns', 'summary'], 'update') &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(campaignSummaryKeys())
        ) ||
        (
          hasPermission(['campaigns', 'ration'], 'update') &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(campaignRationKeys())
        );
      
      // Deleting a campaign
      allow delete: if hasPermission(['campaigns'], 'delete');

      match /beneficiaries/{beneficiaryId} {
        allow get, list: if true; // Required for public summary calculation
        allow create: if hasPermission(['campaigns', 'beneficiaries'], 'create');
        allow update: if hasPermission(['campaigns', 'beneficiaries'], 'update');
        allow delete: if hasPermission(['campaigns', 'beneficiaries'], 'delete');
      }
    }

    match /leads/{leadId} {
      allow get, list: if true;
      allow create: if hasPermission(['leads'], 'create');
      allow update: if 
        hasPermission(['leads'], 'update') ||
        isAdmin() ||
        (
          hasPermission(['leads', 'summary'], 'update') &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(campaignSummaryKeys())
        ) ||
        (
          hasPermission(['leads', 'ration'], 'update') &&
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(campaignRationKeys())
        );
      allow delete: if hasPermission(['leads'], 'delete');

      match /beneficiaries/{beneficiaryId} {
        allow get, list: if canReadLead();
        allow create: if hasPermission(['leads', 'beneficiaries'], 'create');
        allow update: if hasPermission(['leads', 'beneficiaries'], 'update');
        allow delete: if hasPermission(['leads', 'beneficiaries'], 'delete');
      }
    }

    match /donations/{donationId} {
        allow get, list: if true; // Required for public summary calculation
        allow create: if hasPermission(['campaigns', 'donations'], 'create');
        allow update: if hasPermission(['campaigns', 'donations'], 'update');
        allow delete: if hasPermission(['campaigns', 'donations'], 'delete');
    }
  }
}
