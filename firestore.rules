rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Helper Functions ---
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isOwnerOfUserKey(userKey) {
        let userData = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        return userData.userKey == userKey;
    }

    // Get the requesting user's profile data from the 'users' collection
    function getUserData() {
      // Important: Use the request's auth uid, not a wildcard from the path
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function isAdmin() {
      return isSignedIn() && getUserData().role == 'Admin';
    }

    // Check for a specific permission in the user's profile
    function hasPermission(pathSegments, permission) {
      // Admins have all permissions implicitly
      if (isAdmin()) {
        return true;
      }
      
      let perms = getUserData().permissions;
      // Traverse the permission path
      for (let i = 0; i < pathSegments.length; i = i + 1) {
        if (pathSegments[i] in perms) {
          perms = perms[pathSegments[i]];
        } else {
          return false; // Path doesn't exist
        }
      }
      // Check the final permission
      return (permission in perms) && perms[permission] == true;
    }
    
    // --- Collection Rules ---

    match /user_lookups/{lookupId} {
      allow read: if true;
      
      // Allow write if user is admin OR if user is creating/updating their own lookup.
      // This is necessary for self-service phone number updates.
      allow create, update: if (hasPermission(['users'], 'create') || hasPermission(['users'], 'update')) ||
                              (isSignedIn() && isOwnerOfUserKey(request.resource.data.userKey));
                              
      // Allow delete if user is admin OR if user is deleting their own lookup.
      allow delete: if (hasPermission(['users'], 'delete')) ||
                      (isSignedIn() && isOwnerOfUserKey(resource.data.userKey));
    }

    match /users/{userId} {
      allow get: if hasPermission(['users'], 'read') || isOwner(userId);
      allow list: if hasPermission(['users'], 'read');
      
      allow create: if hasPermission(['users'], 'create');

      // Admins can update any field.
      // A user can only update their own name and phone number.
      allow update: if hasPermission(['users'], 'update') || 
                      (isOwner(userId) && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['name', 'phone']));
                      
      allow delete: if hasPermission(['users'], 'delete');
    }

    match /campaigns/{campaignId} {
      // Anyone with any campaign read permission can list/get campaigns
      allow read: if hasPermission(['campaigns'], 'read');
      
      // Creating a campaign
      allow create: if hasPermission(['campaigns'], 'create');
      
      // Updating a campaign document itself requires specific permissions
      // Summary update permission for campaign-level fields
      // Ration update permission for ration-level fields
      allow update: if 
        hasPermission(['campaigns', 'summary'], 'update') ||
        hasPermission(['campaigns', 'ration'], 'update');
      
      // Deleting a campaign
      allow delete: if hasPermission(['campaigns'], 'delete');

      match /beneficiaries/{beneficiaryId} {
        allow read: if hasPermission(['campaigns', 'beneficiaries'], 'read');
        allow create: if hasPermission(['campaigns', 'beneficiaries'], 'create');
        allow update: if hasPermission(['campaigns', 'beneficiaries'], 'update');
        allow delete: if hasPermission(['campaigns', 'beneficiaries'], 'delete');
      }
    }

    match /donations/{donationId} {
        allow read: if hasPermission(['campaigns', 'donations'], 'read');
        allow create: if hasPermission(['campaigns', 'donations'], 'create');
        allow update: if hasPermission(['campaigns', 'donations'], 'update');
        allow delete: if hasPermission(['campaigns', 'donations'], 'delete');
    }
  }
}
