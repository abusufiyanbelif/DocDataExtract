/**
 * ======================================================================
 * Firestore Security Rules
 * ======================================================================
 *
 * Philosophy:
 * This ruleset employs a mixed-privacy model designed for security and functionality.
 *
 * 1. Publicly Readable Data:
 *    - `settings` and published `campaigns`/`leads` are publicly readable. This allows
 *      for public-facing pages to be rendered without requiring user login.
 *    - Individual `donations` are readable with a direct link (for receipts).
 *
 * 2. Authenticated Writes & Lists:
 *    - ALL write operations (create, update, delete) on ANY collection require the
 *      user to be signed in.
 *    - Listing multiple documents (e.g., all donations for a summary) is restricted
 *      to authenticated users to protect private information.
 *
 * 3. Role-Based Access:
 *    - Administrative actions (like managing users or lookups) are protected by the
 *      `isUserAdmin()` function, which checks for an 'Admin' role.
 *    - Most write access for authenticated non-admins is handled by the application's
 *      UI. The rules provide a baseline "must be signed in" check.
 *
 * 4. User-Private Data:
 *    - A user's own profile document at `/users/{userId}` is readable only by that user
 *      or an admin.
 *    - Listing all users is restricted to admins to prevent user enumeration.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }
    
    function isUserAdmin() {
      // Note: This incurs a document read on every check.
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    // --- Publicly Readable Collections ---

    /**
     * @description Public app settings.
     * @allow (read) Anyone can read settings.
     * @allow (write) Only authenticated users (UI restricts to admins).
     */
    match /settings/{docId} {
        allow read: if true;
        allow write: if isSignedIn();
    }
    
    /**
     * @description Individual donation records.
     * @allow (get) Publicly readable for individual receipts.
     * @allow (list) Only signed-in users can list donations for summaries.
     * @allow (write) Only authenticated users can manage donations.
     */
    match /donations/{donationId} {
      allow get: if true;
      allow list: if isSignedIn();
      allow write: if isSignedIn();
    }

    /**
     * @description Campaigns and their beneficiaries.
     */
    match /campaigns/{campaignId} {
      // Allow GET if document is marked public OR user is signed in.
      allow get: if (resource.data.authenticityStatus == 'Verified' && resource.data.publicVisibility == 'Published') || isSignedIn();
      // Allow LIST for anyone; client query is responsible for filtering public/private campaigns.
      allow list: if true;
      // Allow WRITE only for signed-in users.
      allow write: if isSignedIn();

      /**
       * @description Beneficiaries are considered internal data.
       */
      match /beneficiaries/{beneficiaryId} {
          allow read, write: if isSignedIn();
      }
    }
    
    /**
     * @description Leads and their beneficiaries.
     */
    match /leads/{leadId} {
      // Same logic as campaigns.
      allow get: if (resource.data.authenticityStatus == 'Verified' && resource.data.publicVisibility == 'Published') || isSignedIn();
      allow list: if true;
      allow write: if isSignedIn();
      
      /**
       * @description Beneficiaries are considered internal data.
       */
      match /beneficiaries/{beneficiaryId} {
        allow read, write: if isSignedIn();
      }
    }

    // --- Internal & Private Collections ---
    
    /**
     * @description Lookup table for finding a user's email by loginId or phone.
     * @allow (get) Anyone can do a direct lookup (needed for login).
     * @deny (list) Prevent enumeration of all users.
     * @allow (write, delete) Only admins can manage lookup records.
     */
    match /user_lookups/{lookupId} {
        allow get: if true;
        allow list: if false;
        allow write, delete: if isUserAdmin();
    }
    
    /**
     * @description User profile documents.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isUserAdmin();
      allow list: if isUserAdmin(); // Only admins can list all users.
      allow create: if (isOwner(userId) && request.resource.data.id == userId) || isUserAdmin();
      allow update: if (isOwner(userId) && request.resource.data.id == resource.data.id) || isUserAdmin();
      allow delete: if false; // Deleting users should be a privileged server-side operation.
    }
  }
}
