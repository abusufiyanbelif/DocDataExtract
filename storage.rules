rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // ----------------------------------------------------------------------
    // Helper Functions
    // ----------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ----------------------------------------------------------------------
    // Publicly Readable Paths
    // ----------------------------------------------------------------------

    /**
     * @description Public settings files (logo, QR code).
     * Anyone can read these files to display them on public pages.
     * Only authenticated users can upload/delete. The app UI must restrict
     * this to Admin users.
     */
    match /settings/{allPaths=**} {
      allow read: if true;
      allow write: if isSignedIn();
    }

    /**
     * @description Files related to public campaigns (e.g., donation screenshots).
     * These are publicly readable to support public summary pages if the app
     * generates a public URL (controlled by the `screenshotIsPublic` flag in Firestore).
     * Writes are restricted to any signed-in user, with the UI handling role permissions.
     */
    match /campaigns/{campaignId}/{allPaths=**} {
       allow read: if true;
       allow write: if isSignedIn();
    }

    // ----------------------------------------------------------------------
    // Authenticated-Only Paths
    // ----------------------------------------------------------------------
    
    /**
     * @description Files related to internal leads.
     * Leads are considered internal data. Both read and write access
     * are restricted to any authenticated user.
     */
    match /leads/{leadId}/{allPaths=**} {
        allow read, write: if isSignedIn();
    }
    
    /**
     * @description User-specific private files, such as ID proofs.
     * Only the owner of the data can read their own files.
     * Any signed-in user can write (e.g., an Admin uploading on behalf
     * of a user), but this is a permissive rule that relies on the UI
     * to enforce correct behavior.
     */
    match /users/{userId}/{allPaths=**} {
      allow read: if isOwner(userId);
      allow write: if isSignedIn();
    }
  }
}
